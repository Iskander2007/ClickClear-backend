<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Click&Clean ‚Äî –ö–ª–∏–µ–Ω—Ç</title>
  <link rel="stylesheet" href="./css/style.css" />
</head>

<body data-page="client">
  <!-- HEADER -->
  <header class="container header">
    <div class="brand">
      <div style="width:40px;height:40px;border-radius:12px;background:#f2fff8;display:grid;place-items:center;">üß∫</div>
      <span class="brand-title">Click&Clean</span>
    </div>
    <nav class="nav">
      <a href="./index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="./orders.html">–ó–∞–∫–∞–∑—ã</a>
      <a href="./client.html">–ö–ª–∏–µ–Ω—Ç</a>
    </nav>
    <div class="header-actions">
      <button id="logout-btn" class="btn btn--ghost">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container">
    <h1>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</h1>

    <section class="glass">
      <form id="orderForm">
        <div class="form">
          <div class="row">
            <label>–†–∞–π–æ–Ω</label>
            <select id="district" required></select>
          </div>

          <div class="row">
            <label>–ê–¥—Ä–µ—Å</label>
            <input id="address" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞" required>
          </div>

          <div class="row">
            <label>–î–∞—Ç–∞</label>
            <input id="date" type="date" required>
          </div>

          <div class="row">
            <label>–í—Ä–µ–º—è</label>
            <select id="slot" required></select>
          </div>

          <div class="row">
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea id="comment" placeholder="–ü–æ–¥—ä–µ–∑–¥, —ç—Ç–∞–∂, –∫–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞ –∏ —Ç.–¥."></textarea>
          </div>

          <div class="row">
            <label>–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ (‚Ç∏)</label>
            <input id="amount" type="number" min="500" step="100" value="1000" required>
          </div>

          <button class="btn" type="submit">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </form>
    </section>

    <h2 style="margin-top:30px;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
    <div id="myOrders" class="orders-mobile"></div>
  </main>

  <nav class="mobile-tabbar">
    <a href="./index.html" data-tab="home">üè†<span>–ì–ª–∞–≤–Ω–∞—è</span></a>
    <a href="./orders.html" data-tab="orders">üì¶<span>–ó–∞–∫–∞–∑—ã</span></a>
    <a href="./client.html" data-tab="client" class="active">üë§<span>–ö–ª–∏–µ–Ω—Ç</span></a>
    <a href="./courier.html" data-tab="courier">üõµ<span>–ö—É—Ä—å–µ—Ä</span></a>
  </nav>

  <script type="module">
    import { createOrder, getDistricts, getSlots, me } from './js/api.js';

    const $ = s => document.querySelector(s);
    const districtEl = $('#district');
    const slotEl = $('#slot');
    const ordersBox = $('#myOrders');

    // ======= –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ =======
    const token = localStorage.getItem('token');
    if (!token) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
      window.location.href = './index.html';
    }

    // ======= –í—ã—Ö–æ–¥ =======
    $('#logout-btn')?.addEventListener('click', () => {
      localStorage.clear();
      window.location.href = './index.html';
    });

    // ======= –ü–æ–¥–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö =======
    async function loadMeta() {
  try {
    const [districts, slots] = await Promise.all([getDistricts(), getSlots()]);
    console.log("üì¶ –†–∞–π–æ–Ω—ã:", districts);
    console.log("üïì –°–ª–æ—Ç—ã:", slots);

    districtEl.innerHTML = districts.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    slotEl.innerHTML = slots.map(s => `<option value="${s.value}">${s.label}</option>`).join('');
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:", err);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ backend (python manage.py runserver).");
  }
}


    // ======= –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ =======
    $('#orderForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const payload = {
    district: Number($('#district').value),
    address: $('#address').value.trim(),
    date: $('#date').value,
    slot: $('#slot').value,
    comment: $('#comment').value.trim(),
    amount: Number($('#amount').value),
  };

  try {
    console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑:", payload);

    const res = await createOrder(payload);

    console.log("üì© –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", res);

    if (res && res.id) {
      alert('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
      e.target.reset();
      loadMyOrders();
    } else if (res && res.detail) {
      alert('‚ùå –û—à–∏–±–∫–∞: ' + res.detail);
    } else {
      alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º–æ—Ç—Ä–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.');
    }
  } catch (err) {
    console.error('üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:', err);
    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
  }
});



    // ======= –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–∏—Ö –∑–∞–∫–∞–∑–æ–≤ =======
    async function loadMyOrders() {
      const r = await fetch('http://127.0.0.1:8000/api/my/orders', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await r.json();

      if (!Array.isArray(data) || data.length === 0) {
        ordersBox.innerHTML = `
          <div class="empty">
            <div style="font-size:64px;">üß∫</div>
            <h3>–ü–æ–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</h3>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ ‚Äî –æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
          </div>`;
        return;
      }

      ordersBox.innerHTML = data.map(o => `
        <article class="order-card">
          <h4>#${o.id} ‚Äî ${o.amount} ‚Ç∏</h4>
          <div class="order-meta">
            <div><b>–ê–¥—Ä–µ—Å:</b> ${o.address}</div>
            <div><b>–†–∞–π–æ–Ω:</b> ${o.district_name || '‚Äî'}</div>
            <div><b>–î–∞—Ç–∞:</b> ${o.date || '‚Äî'}</div>
            <div><b>–°–ª–æ—Ç:</b> ${o.slot || '‚Äî'}</div>
            <div><b>–°—Ç–∞—Ç—É—Å:</b> ${o.status || 'new'}</div>
          </div>
        </article>
      `).join('');
    }

    window.addEventListener("DOMContentLoaded", () => {
  console.log("‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");
  loadMeta();
  document.querySelector('.form').classList.add('active');
  loadMyOrders();
});
  </script>
</body>
</html>
